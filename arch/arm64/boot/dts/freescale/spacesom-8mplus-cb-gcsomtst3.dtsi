// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2022 SomLabs Astar
 *
 */

#include <dt-bindings/pwm/pwm.h>
#include "spacesom-8mplus.dtsi"
#include "spacesom-8mplus-cb-sound-nau8822.dtsi"

/ {
        model = "Astar SpaceSOM i.MX8MPlus CB-GC-SOM-TST3";

        aliases {
		rtc0 = &pcf85263;
		rtc1 = &snvs_rtc;
	};

        dummy: regulator-dummy {
                compatible = "regulator-fixed";
                regulator-name = "dummy";
	        regulator-always-on;
        };

        leds {
                pinctrl-0 = <&pinctrl_gpio_leds_cb>;

                led-io-05 {
                        label = "LED-IO-05";
                        gpios = <&gpio1 5 0>;
                        default-state = "off";
                };
                led-io-06 {
                        label = "LED-IO-06";
                        gpios = <&gpio1 6 0>;
                        default-state = "off";
                };
                led-io-07 {
                        label = "LED-IO-07";
                        gpios = <&gpio1 7 0>;
                        default-state = "off";
                };
        };


        somstatus {
                pinctrl-0 = <&pinctrl_gpio_som_status>;
                pinctrl-names = "default";
                status = "okay";
                status-io-01 {
                        label = "STATUS-IO-01";
                        gpios = <&gpio1 9 0>;
                        default-state = "off";
                };
        };

        gpio_buttons: gpio_buttons0 {
                compatible = "gpio-keys";
                pinctrl-names = "default";
                pinctrl-0 = <&pinctrl_gpio_buttons_cb>;
                #address-cells = <1>;
                #size-cells = <0>;

                switch1 {
                        label = "BTN-IO-11";
                        linux,code = <0x100>;
                        gpios = <&gpio1 11 GPIO_ACTIVE_LOW>;
                };

                switch2 {
                        label = "BTN-IO-10";
                        linux,code = <0x101>;
                        gpios = <&gpio1 10 GPIO_ACTIVE_LOW>;
                };

                switch4 {
                        label = "BTN-IO-08";
                        linux,code = <0x103>;
                        gpios = <&gpio1 8 GPIO_ACTIVE_LOW>;
                };
        };

        panel_backlight: panel-backlight {
                compatible = "pwm-backlight";
                pinctrl-names = "default";
                pinctrl-0 = <&pinctrl_panel_backlight_en>;
                pwms = <&pwm1 0 25000 PWM_POLARITY_INVERTED>;

                brightness-levels = < 0  1  2  3  4  5  6  7  8  9
                                     10 11 12 13 14 15 16 17 18 19
                                     20 21 22 23 24 25 26 27 28 29
                                     30 31 32 33 34 35 36 37 38 39
                                     40 41 42 43 44 45 46 47 48 49
                                     50 51 52 53 54 55 56 57 58 59
                                     60 61 62 63 64 65 66 67 68 69
                                     70 71 72 73 74 75 76 77 78 79
                                     80 81 82 83 84 85 86 87 88 89
                                     90 91 92 93 94 95 96 97 98 99
                                     100>;
                default-brightness-level = <80>;

                enable-gpios = <&gpio4 31 0>;
                //status = "disabled";
                //status = "okay";
        };
};

&eqos {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_eqos>;
        phy-int-gpios = <&gpio4 20 GPIO_ACTIVE_LOW>; /* GPIO4_20 */
        phy-mode = "rmii";
        phy-handle = <&ethphy0>;
        snps,force_thresh_dma_mode;
        snps,mtl-tx-config = <&mtl_tx_setup>;
        snps,mtl-rx-config = <&mtl_rx_setup>;
        status = "okay";
        snps,rmii_refclk_ext;

        mdio {
                compatible = "snps,dwmac-mdio";
                #address-cells = <1>;
                #size-cells = <0>;

                ethphy0: ethernet-phy@1 {
                        compatible = "ethernet-phy-ieee802.3-c22";
                        reg = <1>;
                        eee-broken-1000t;
                        reset-gpios = <&gpio3 16 GPIO_ACTIVE_LOW>;
                        reset-assert-us = <10000>;
                        reset-deassert-us = <80000>;
                        //realtek,clkout-disable;
                };
        };

        mtl_tx_setup: tx-queues-config {
                snps,tx-queues-to-use = <5>;
                snps,tx-sched-sp;
                queue0 {
                        snps,dcb-algorithm;
                        snps,priority = <0x1>;
                };
                queue1 {
                        snps,dcb-algorithm;
                        snps,priority = <0x2>;
                };
                queue2 {
                        snps,dcb-algorithm;
                        snps,priority = <0x4>;
                };
                queue3 {
                        snps,dcb-algorithm;
                        snps,priority = <0x8>;
                };
                queue4 {
                        snps,dcb-algorithm;
                        snps,priority = <0xf0>;
                };
        };

        mtl_rx_setup: rx-queues-config {
                snps,rx-queues-to-use = <5>;
                snps,rx-sched-sp;
                queue0 {
                        snps,dcb-algorithm;
                        snps,priority = <0x1>;
                        snps,map-to-dma-channel = <0>;
                };
                queue1 {
                        snps,dcb-algorithm;
                        snps,priority = <0x2>;
                        snps,map-to-dma-channel = <1>;
                };
                queue2 {
                        snps,dcb-algorithm;
                        snps,priority = <0x4>;
                        snps,map-to-dma-channel = <2>;
                };
                queue3 {
                        snps,dcb-algorithm;
                        snps,priority = <0x8>;
                        snps,map-to-dma-channel = <3>;
                };
                queue4 {
                        snps,dcb-algorithm;
                        snps,priority = <0xf0>;
                        snps,map-to-dma-channel = <4>;
                };
        };
};

&fec {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_fec>;
        phy-int-gpios = <&gpio4 19 GPIO_ACTIVE_LOW>; /* GPIO4_19 */
        phy-mode = "rgmii-id";
        //phy-mode = "rgmii-rxid"; //tobylo
        phy-handle = <&ethphy1>;
        fsl,magic-packet;
        status = "okay";

        mdio {
                #address-cells = <1>;
                #size-cells = <0>;

                ethphy1: ethernet-phy@1 {
                        compatible = "ethernet-phy-ieee802.3-c22";
                        reg = <1>;
                        eee-broken-1000t;
                        reset-gpios = <&gpio4 18 GPIO_ACTIVE_LOW>;
                        reset-assert-us = <10000>;
                        reset-deassert-us = <80000>;
                        realtek,aldps-enable;
                        realtek,clkout-disable;
                };
        };     
};

&iomuxc {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_gpio_som_status>;
/*        
        pinctrl-0 = <&pinctrl_hog>;

        pinctrl_hog: hoggrp {
                fsl,pins = <
                        MX8MP_IOMUXC_HDMI_DDC_SCL__HDMIMIX_HDMI_SCL     0x400001c3
                        MX8MP_IOMUXC_HDMI_DDC_SDA__HDMIMIX_HDMI_SDA     0x400001c3
                        MX8MP_IOMUXC_HDMI_HPD__HDMIMIX_HDMI_HPD         0x40000019
                        MX8MP_IOMUXC_HDMI_CEC__HDMIMIX_HDMI_CEC         0x40000019
                >;
        };
 */       

        pinctrl_gpio_leds_cb: gpioledscb {          /* 4x LEDs on  carrier board */
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO05__GPIO1_IO05             0x19
                        MX8MP_IOMUXC_GPIO1_IO06__GPIO1_IO06             0x19
                        MX8MP_IOMUXC_GPIO1_IO07__GPIO1_IO07             0x19
                >;
        };

        pinctrl_gpio_buttons_cb: gpiobuttonscb {      /* 4x buttons on  carrier board */
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO08__GPIO1_IO08             0x1c0
                        MX8MP_IOMUXC_GPIO1_IO10__GPIO1_IO10             0x1c0
                        MX8MP_IOMUXC_GPIO1_IO11__GPIO1_IO11             0x1c0
                >;
        };

        pinctrl_gpio_som_status: gpiosomstatus {
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO09__GPIO1_IO09             0x19
                >;
        };

        pinctrl_panel_backlight_en: panel_backlight_en {
                fsl,pins = <
                        MX8MP_IOMUXC_SAI5_RXD1__GPIO3_IO22                 0x19
                >;
        };

        pinctrl_panel_backlight_pwm: panel_backlight_pwm {
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO01__PWM1_OUT               0x19
                >;
        };

        pinctrl_panel_reset: panel_reset {
                fsl,pins = <
                        MX8MP_IOMUXC_SAI3_TXC__GPIO5_IO00               0x19
                >;
        };

        pinctrl_csi0: csi0_grp {
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO00__GPIO1_IO00             0x19
                >;
        };

        pinctrl_csi1: csi1_grp {
                fsl,pins = <
                        MX8MP_IOMUXC_UART1_RXD__GPIO5_IO22              0x19
                        MX8MP_IOMUXC_UART1_TXD__GPIO5_IO23              0x19
                >;
        };

        pinctrl_eqos: eqosgrp {
                fsl,pins = <
                        MX8MP_IOMUXC_ENET_MDC__ENET_QOS_MDC                             0x3
                        MX8MP_IOMUXC_ENET_MDIO__ENET_QOS_MDIO                           0x3
                        MX8MP_IOMUXC_ENET_RD0__ENET_QOS_RGMII_RD0                       0x91
                        MX8MP_IOMUXC_ENET_RD1__ENET_QOS_RGMII_RD1                       0x91
                        MX8MP_IOMUXC_ENET_RD2__ENET_QOS_RGMII_RD2                       0x91
                        MX8MP_IOMUXC_ENET_RD3__ENET_QOS_RGMII_RD3                       0x91
                        MX8MP_IOMUXC_ENET_RXC__CCM_ENET_QOS_CLOCK_GENERATE_RX_CLK       0x91
                        MX8MP_IOMUXC_ENET_RX_CTL__ENET_QOS_RGMII_RX_CTL                 0x91
                        MX8MP_IOMUXC_ENET_TD0__ENET_QOS_RGMII_TD0                       0x1f
                        MX8MP_IOMUXC_ENET_TD1__ENET_QOS_RGMII_TD1                       0x1f
                        MX8MP_IOMUXC_ENET_TD2__CCM_ENET_QOS_CLOCK_GENERATE_REF_CLK      0x1f
                        MX8MP_IOMUXC_ENET_TD3__ENET_QOS_RGMII_TD3                       0x1f
                        MX8MP_IOMUXC_ENET_TX_CTL__ENET_QOS_RGMII_TX_CTL                 0x1f
                        MX8MP_IOMUXC_ENET_TXC__CCM_ENET_QOS_CLOCK_GENERATE_TX_CLK       0x1f
                        MX8MP_IOMUXC_NAND_READY_B__GPIO3_IO16                           0x19    /* phy reset */
                        MX8MP_IOMUXC_SAI1_MCLK__GPIO4_IO20                              0x41    /* phy int */
                >;
        };

        pinctrl_fec: fecgrp {
                fsl,pins = <
                        MX8MP_IOMUXC_SAI1_RXD2__ENET1_MDC               0x3
                        MX8MP_IOMUXC_SAI1_RXD3__ENET1_MDIO              0x3
                        MX8MP_IOMUXC_SAI1_RXD4__ENET1_RGMII_RD0         0x91
                        MX8MP_IOMUXC_SAI1_RXD5__ENET1_RGMII_RD1         0x91
                        MX8MP_IOMUXC_SAI1_RXD6__ENET1_RGMII_RD2         0x91
                        MX8MP_IOMUXC_SAI1_RXD7__ENET1_RGMII_RD3         0x91
                        MX8MP_IOMUXC_SAI1_TXC__ENET1_RGMII_RXC          0x91
                        MX8MP_IOMUXC_SAI1_TXFS__ENET1_RGMII_RX_CTL      0x91
                        MX8MP_IOMUXC_SAI1_TXD0__ENET1_RGMII_TD0         0x1f
                        MX8MP_IOMUXC_SAI1_TXD1__ENET1_RGMII_TD1         0x1f
                        MX8MP_IOMUXC_SAI1_TXD2__ENET1_RGMII_TD2         0x1f
                        MX8MP_IOMUXC_SAI1_TXD3__ENET1_RGMII_TD3         0x1f
                        MX8MP_IOMUXC_SAI1_TXD4__ENET1_RGMII_TX_CTL      0x1f
                        MX8MP_IOMUXC_SAI1_TXD5__ENET1_RGMII_TXC         0x1f
                        MX8MP_IOMUXC_SAI1_TXD6__GPIO4_IO18              0x19    /* phy reset */
                        MX8MP_IOMUXC_SAI1_TXD7__GPIO4_IO19              0x41    /* phy int */
                >;
        };

        //pinctrl_fec_1588: fec1588grp {
        //        fsl,pins = <
        //                MX8MP_IOMUXC_SAI1_RXFS__ENET1_1588_EVENT0_IN    0x91
        //                MX8MP_IOMUXC_SAI1_RXC__ENET1_1588_EVENT0_OUT    0x1f
        //                MX8MP_IOMUXC_SAI1_RXD0__ENET1_1588_EVENT1_IN    0x91
        //                MX8MP_IOMUXC_SAI1_RXD1__ENET1_1588_EVENT1_OUT   0x1f
        //        >;
        //};

        pinctrl_touch: touch_grp {
                fsl,pins = <
                        MX8MP_IOMUXC_GPIO1_IO04__GPIO1_IO04               0x19
                        MX8MP_IOMUXC_GPIO1_IO03__GPIO1_IO03               0x1c0
                >;
        };      

        pinctrl_sai3: sai3grp {
                fsl,pins = <
                        MX8MP_IOMUXC_SAI3_RXFS__AUDIOMIX_SAI3_RX_SYNC	0xd6
                        MX8MP_IOMUXC_SAI3_RXC__AUDIOMIX_SAI3_RX_BCLK	0xd6
                        MX8MP_IOMUXC_SAI3_RXD__AUDIOMIX_SAI3_RX_DATA00	0xd6
                        MX8MP_IOMUXC_SAI3_TXD__AUDIOMIX_SAI3_TX_DATA00	0xd6
                        MX8MP_IOMUXC_SAI3_MCLK__AUDIOMIX_SAI3_MCLK	0xd6
                >;
        };

        pinctrl_usdhc1_gpio: usdhc1gpiogrp {
                fsl,pins = <
                        MX8MP_IOMUXC_SD1_RESET_B__GPIO2_IO10            0x1c4
                >;
        };

        pinctrl_usdhc1: usdhc1grp {
                fsl,pins = <
                        MX8MP_IOMUXC_SD1_CLK__USDHC1_CLK                0x190
                        MX8MP_IOMUXC_SD1_CMD__USDHC1_CMD                0x1d0
                        MX8MP_IOMUXC_SD1_DATA0__USDHC1_DATA0            0x1d0
                        MX8MP_IOMUXC_SD1_DATA1__USDHC1_DATA1            0x1d0
                        MX8MP_IOMUXC_SD1_DATA2__USDHC1_DATA2            0x1d0
                        MX8MP_IOMUXC_SD1_DATA3__USDHC1_DATA3            0x1d0
                >;
        };

        pinctrl_uart2_rts: uart2rtsgrp {
                fsl,pins = <
                        MX8MP_IOMUXC_SPDIF_EXT_CLK__GPIO5_IO05          0x19
                >;
        };

        pinctrl_typec: typec1grp {
                fsl,pins = <
                        MX8MP_IOMUXC_SD1_STROBE__GPIO2_IO11             0x1c4
                >;
        };

};

&usdhc1 {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_usdhc1 &pinctrl_usdhc1_gpio>;

        cd-gpios = <&gpio2 10 GPIO_ACTIVE_HIGH>;
        no-1-8-v;           //todo: PMIC allows to control SD card voltage, add support for this in software/dts
        bus-width = <4>;
        fsl,delay-line = <8>;
        status = "okay";
};

&usb3_phy0 {
        fsl,phy-tx-vref-tune = <0xe>;
        fsl,phy-tx-preemp-amp-tune = <3>;
        fsl,phy-tx-vboost-level = <5>;
        fsl,phy-comp-dis-tune = <7>;
        fsl,pcs-tx-deemph-3p5db = <0x21>;
        fsl,phy-pcs-tx-swing-full = <0x7f>;
        status = "okay";
};

&usb3_0 {
        status = "okay";
};

&usb_dwc3_0 {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_usb0_vbus>;
        dr_mode = "host";
        hnp-disable;
        srp-disable;
        adp-disable;
        usb-role-switch;
//      role-switch-default-mode = "none";
        status = "okay";

        //port {
        //        usb3_role_switch: endpoint {
        //                remote-endpoint = <&pi5usb30213a_ep>;
        //        };
        //};
};

&usb3_phy1 {
        fsl,phy-tx-preemp-amp-tune = <3>;
        fsl,phy-tx-vref-tune = <0xb>;
        status = "okay";
};

&usb3_1 {
        status = "okay";
};

&usb_dwc3_1 {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_usb1_vbus>;
        dr_mode = "host";
        status = "okay";
};

&irqsteer_hdmi {
        status = "okay";
};

&hdmi_blk_ctrl {
        status = "okay";
};

&hdmi_pavi {
        status = "okay";
};

&hdmi {
        status = "okay";
};

&hdmiphy {
        status = "okay";
};

&aud2htx {
	status = "okay";
};

&lcdif1 {
        status = "okay";
};

/*
&lcdif2 {
        status = "okay";
};

&lcdif3 {
        status = "okay";

        thres-low  = <1 2>;             
        thres-high = <3 4>;            
};
*/

&pcie{
        pinctrl-names = "default";
        // pinctrl-0 = <&pinctrl_pcie>;
        // disable-gpio = <&gpio2 6 GPIO_ACTIVE_LOW>;
        // reset-gpio = <&gpio2 7 GPIO_ACTIVE_LOW>;
        clocks = <&clk IMX8MP_CLK_HSIO_ROOT>,
                <&clk IMX8MP_CLK_PCIE_AUX>,
                <&clk IMX8MP_CLK_HSIO_AXI>,
                <&clk IMX8MP_CLK_PCIE_ROOT>;
        clock-names = "pcie", "pcie_aux", "pcie_phy", "pcie_bus";
        assigned-clocks = <&clk IMX8MP_CLK_HSIO_AXI>,
                          <&clk IMX8MP_CLK_PCIE_AUX>;
        assigned-clock-rates = <500000000>, <10000000>;
        assigned-clock-parents = <&clk IMX8MP_SYS_PLL2_500M>,
                                <&clk IMX8MP_SYS_PLL2_50M>;
        ext_osc = <0>;
        status = "okay";
};

&pcie_phy{
        ext_osc = <0>;
        status = "okay";
};

&sai3 {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_sai3>;
        assigned-clocks = <&clk IMX8MP_CLK_SAI3>;
 	assigned-clock-parents = <&clk IMX8MP_AUDIO_PLL1_OUT>;
        assigned-clock-rates = <12288000>;
        //assigned-clock-rates = <786432000>, <49152000>, <12288000>;
        fsl,sai-synchronous-rx;
        fsl,sai-mclk-direction-output;
        #sound-dai-cells = <0>;
        status = "okay";
};

&i2c3 {
        clock-frequency = <400000>;
        status = "okay";

        pcf85263: rtc@51 {
          compatible = "nxp,pcf85263";
          reg = <0x51>;
          status = "okay";
        };
        
        eeprom_board: eeprom@54 {
                compatible = "i2c-eeprom", "atmel,24c64";
 		pagesize = <32>;
		address-width = <16>;
 		reg = <0x54>;
        };
        
};

/*
&i2c4 {
        clock-frequency = <100000>;
        status = "okay";
};
*/

&ecspi1 {
        pinctrl-names = "default";
        pinctrl-0 = <&pinctrl_ecspi1 &pinctrl_ecspi1_cs>;
        cs-gpios = <&gpio5 9 GPIO_ACTIVE_LOW>;
        status = "okay";

        system_agent: spidev@0 {
               compatible = "astar,sys-agent";
               spi-max-frequency = <12000000>;
               reg = <0>;
        };
};

/*
&ldb {
        status = "okay";

        lvds-channel@0 {
                fsl,data-mapping = "spwg";
                fsl,data-width = <24>;
                status = "okay";

                port@1 {
                        reg = <1>;
                        lvds_out: endpoint {
                                remote-endpoint = <&panel_lvds_in>;
                        };
                };
        };
};

&ldb_phy {
        status = "okay";
};
*/

/*
&mipi_csi_0 {
        #address-cells = <1>;
        #size-cells = <0>;
        status = "disabled";

        port@0 {
                reg = <0>;
                mipi_csi0_ep: endpoint {
                        remote-endpoint = <&ov5640_mipi_0_ep>;
                        data-lanes = <2>;
                        csis-hs-settle = <13>;
                        csis-clk-settle = <2>;
                        csis-wclk;
                };
        };
};

&mipi_csi_1 {
        #address-cells = <1>;
        #size-cells = <0>;
        status = "disabled";

        port@1 {
                reg = <1>;
                mipi_csi1_ep: endpoint {
                        remote-endpoint = <&ov5640_mipi_1_ep>;
                        data-lanes = <2>;
                        csis-hs-settle = <13>;
                        csis-clk-settle = <2>;
                        csis-wclk;
                        swap-clk;
                        swap-data;
                };
        };
};
*/

&cameradev {
        status = "disabled";
};

&isi_0 {
        status = "okay";

        cap_device {
                status = "okay";
        };

        m2m_device {
                status = "okay";
        };
};

&isi_1 {
        status = "okay";

        cap_device {
                status = "okay";
        };
};

&flexcan1 {
        status = "disabled";
};

&flexcan2 {
        status = "disabled";
};

&pwm1 {
    pinctrl-names = "default";
    pinctrl-0 = <&pinctrl_panel_backlight_pwm>;
    status = "okay";
    //status = "disabled";
};

&uart2 {
    pinctrl-0 = <&pinctrl_uart2 &pinctrl_uart2_rts>;
    rts-gpios = <&gpio5 5 GPIO_ACTIVE_LOW>;
    linux,rs485-enabled-at-boot-time;
    status = "okay";
};
